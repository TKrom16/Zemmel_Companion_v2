<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deadlands Companion</title>

<!-- Manifest (PWA) -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#FDEBC9">

<!-- Tailwind (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<style>
  body {
    overflow-x: hidden;
    background-color: #FDEBC9; /* yellow-beige western background */
  }

  /* Base tab style (shared) */
  .tab {
    font-weight: 600;
    border-radius: .375rem;
    padding: .5rem .75rem;
    text-align: center;
    width: 100%;
    border: 2px solid transparent;
    box-sizing: border-box;
    cursor: pointer;
  }

  /* selected highlight: dark border */
  .tab.tab-active {
    border-color: rgba(0,0,0,0.5); /* dark border for selection */
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
  }

  /* color variants (muted tones) */
  .color-traits { background: #b0b4b8; color: #0f1724; } /* slightly darker gray */
  .color-powers { background: #6897c8; color: #04263b; } /* muted blue */
  .color-edges { background: #7fb376; color: #06391c; }  /* muted green */
  .color-hindrances { background: #c86f67; color: #3a0f0e; } /* muted red */

  /* child buttons (My ...) star-only */
  .child {
    font-weight: 600;
    border-radius: .375rem;
    padding: .3rem .5rem;
    text-align: center;
    width: 100%;
    border: 2px solid transparent;
    box-sizing: border-box;
    font-size: 1rem;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  .child.tab-active { border-color: rgba(0,0,0,0.5); box-shadow: 0 6px 14px rgba(0,0,0,0.06); }

  .child svg { width: 20px; height: 20px; display:block; }

  .modal {
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.6); z-index: 50; padding: 0;
  }
  .modal.open { display: flex; }
  .modal-content {
    background: #fff; border-radius: .5rem; width: 95%; height: auto;
    max-height: 90vh; overflow-y: auto; padding: 1.25rem; position: relative; text-align: left;
  }
  @media (min-width: 768px) {
    .modal-content { max-width: 900px; max-height: 80vh; margin: 2rem; }
  }
  .close-btn { position: absolute; top: .75rem; right: .75rem; font-weight: 700;
               background: transparent; border: none; cursor: pointer; font-size: 1.5rem; }
  .modal-text { white-space: pre-wrap; text-align: left; }
  .focus-ring:focus { outline: 3px solid rgba(99,102,241,0.35); outline-offset: 2px; }
  .trait-parent { font-style: italic; color: #b91c1c; margin-top: 0.25rem; display: block; }
  .summary-text { text-align: left; }

  /* 3-column grid so row2 and row3 line up */
  .grid-3 {
    display: grid;
    grid-template-columns: repeat(3, minmax(0,1fr));
    gap: .5rem;
    width: 100%;
  }

  /* controls helpers */
  /* Row with search + clear: no wrap so Clear stays on same row */
  .controls-row {
    display:flex;
    gap:.5rem;
    flex-wrap:nowrap;            /* prevent wrapping of Clear */
    align-items:center;
    justify-content:center;
    width:100%;
  }
  .controls-row-left {
    display:flex;
    gap:.5rem;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-start;
    width:100%;
  }

  .w-full-sm { width:100%; min-width:0; }

  /* allow inputs to shrink when necessary */
  .controls-row input[type="search"] {
    min-width: 0;   /* allow flex to shrink */
    flex: 1 1 auto;
  }

  /* highlight background only for first 5 trait cards (same gray as Traits button) */
  .trait-card-highlight { background: #b0b4b8; }

  /* small visual tweak so star buttons look like their parents */
  .color-powers.child svg { color: inherit; fill: white; stroke: rgba(0,0,0,0.06); }
  .color-edges.child svg { color: inherit; fill: white; stroke: rgba(0,0,0,0.06); }
  .color-hindrances.child svg { color: inherit; fill: white; stroke: rgba(0,0,0,0.06); }

  .child svg { width: 20px; height: 20px; }
</style>
</head>

<body class="text-gray-900">
<div class="container mx-auto p-4 text-center">
  <!-- Update this logo URL if needed -->
  <img id="logoImg" src="https://raw.githubusercontent.com/TKrom16/Zemmel_Companion_DL/refs/heads/main/Logo.png" alt="Deadlands Logo" class="mx-auto w-full max-w-md mb-4">
  <h1 class="text-2xl md:text-3xl font-bold mb-6">Companion App</h1>

  <!-- Row 1: Traits (full width) -->
  <div class="mb-4">
    <button id="tab_traits" class="tab color-traits text-lg font-semibold" type="button">Traits</button>
  </div>

  <!-- Row 2 & 3: 3-column grid so Row3 buttons match the widths of Row2 parents -->
  <div class="grid-3 mb-3" role="tablist">
    <!-- Row2 col1: Powers -->
    <div><button id="tab_powers" class="tab color-powers" type="button">Powers</button></div>
    <!-- Row2 col2: Edges -->
    <div><button id="tab_edges" class="tab color-edges" type="button">Edges</button></div>
    <!-- Row2 col3: Hindrances -->
    <div><button id="tab_hindrances" class="tab color-hindrances" type="button">Hindrances</button></div>

    <!-- Row3 col1: My Powers (star-only) -->
    <div>
      <button id="powers_view_my" class="child color-powers" title="My Powers" type="button">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 17.3l-6.16 3.24 1.18-6.88L2 9.76l6.92-1.01L12 2.5l3.08 6.25L22 9.76l-5.02 4.9 1.18 6.88L12 17.3z"
                fill="currentColor" stroke="rgba(0,0,0,0.06)"></path>
        </svg>
      </button>
    </div>

    <!-- Row3 col2: My Edges -->
    <div>
      <button id="edges_view_my" class="child color-edges" title="My Edges" type="button">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 17.3l-6.16 3.24 1.18-6.88L2 9.76l6.92-1.01L12 2.5l3.08 6.25L22 9.76l-5.02 4.9 1.18 6.88L12 17.3z"
                fill="currentColor" stroke="rgba(0,0,0,0.06)"></path>
        </svg>
      </button>
    </div>

    <!-- Row3 col3: My Hindrances -->
    <div>
      <button id="hindrances_view_my" class="child color-hindrances" title="My Hindrances" type="button">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 17.3l-6.16 3.24 1.18-6.88L2 9.76l6.92-1.01L12 2.5l3.08 6.25L22 9.76l-5.02 4.9 1.18 6.88L12 17.3z"
                fill="currentColor" stroke="rgba(0,0,0,0.06)"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Controls -->
  <div id="controls" class="mb-4">
    <!-- POWERS controls -->
    <div id="controls_powers" class="hidden">
      <!-- Row 4: Filters -->
      <div class="controls-row-left mb-2">
        <select id="rankFilter_powers" class="border p-2 rounded">
          <option value="">All Ranks</option>
          <option>Novice</option>
          <option>Seasoned</option>
          <option>Veteran</option>
          <option>Heroic</option>
          <option>Legendary</option>
        </select>
        <button id="btnCommonMods" class="border p-2 rounded bg-white focus-ring flex items-center gap-1" type="button">
          <span>‚ö°</span><span>Common Modifiers</span>
        </button>
      </div>
      <!-- Row 5: Search + Clear -->
      <div class="controls-row">
        <input id="searchBox_powers" type="search" placeholder="Search name or summary..." class="border p-2 rounded flex-grow min-w-0 w-full-sm">
        <button id="clearBtn_powers" class="border p-2 rounded bg-gray-50 min-w-[70px]" type="button">Clear</button>
      </div>
    </div>

    <!-- EDGES controls -->
    <div id="controls_edges" class="hidden">
      <div class="controls-row-left mb-2">
        <select id="rankFilter_edges" class="border p-2 rounded">
          <option value="">All Ranks</option>
          <option>Novice</option>
          <option>Seasoned</option>
          <option>Veteran</option>
          <option>Heroic</option>
          <option>Legendary</option>
        </select>
        <select id="categoryFilter_edges" class="border p-2 rounded">
          <option value="">All Categories</option>
        </select>
      </div>
      <div class="controls-row">
        <input id="searchBox_edges" type="search" placeholder="Search name or summary..." class="border p-2 rounded flex-grow min-w-0 w-full-sm">
        <button id="clearBtn_edges" class="border p-2 rounded bg-gray-50 min-w-[70px]" type="button">Clear</button>
      </div>
    </div>

    <!-- HINDRANCES controls -->
    <div id="controls_hindrances" class="hidden">
      <div class="controls-row-left mb-2">
        <select id="typeFilter_hindrances" class="border p-2 rounded">
          <option value="">All Types</option>
          <option>Minor</option>
          <option>Major</option>
        </select>
      </div>
      <div class="controls-row">
        <input id="searchBox_hindrances" type="search" placeholder="Search name or summary..." class="border p-2 rounded flex-grow min-w-0 w-full-sm">
        <button id="clearBtn_hindrances" class="border p-2 rounded bg-gray-50 min-w-[70px]" type="button">Clear</button>
      </div>
    </div>

    <!-- Traits controls -->
    <div id="controls_traits" class="hidden text-center text-gray-600 text-sm">
      <!-- nothing for traits -->
    </div>
  </div>

  <!-- List Area -->
  <div id="itemsList" class="grid gap-3 grid-cols-1 md:grid-cols-2 text-left"></div>
</div>

<!-- Modals -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-content" id="modalContent" onclick="event.stopPropagation()">
    <button id="modalClose" class="close-btn" type="button">‚úï</button>
    <h2 id="modalName" class="text-2xl font-bold mb-1"></h2>
    <p id="modalRank" class="text-sm text-red-700 font-semibold mb-3"></p>
    <div id="modalStats" class="text-sm text-gray-700 mb-3 space-y-1"></div>
    <hr class="my-3 border-gray-300" />
    <div id="modalText" class="modal-text text-gray-900 text-base leading-relaxed text-left mb-4"></div>
    <hr class="my-3 border-gray-300" />
    <div id="modalModifiersContainer" class="mt-4 hidden">
      <h3 class="font-semibold mb-2">Power Modifiers</h3>
      <div id="modalModifiers" class="space-y-3"></div>
    </div>
    <p id="modalSource" class="text-sm text-gray-600 mb-3"></p>
    <div class="mt-6 flex gap-2 flex-wrap justify-center">
      <button id="modalFavBtn" class="px-3 py-2 rounded bg-indigo-600 text-white" type="button"></button>
      <button id="modalCopyBtn" class="px-3 py-2 rounded border bg-white" type="button">Copy Summary</button>
    </div>
  </div>
</div>

<div id="commonModal" class="modal" aria-hidden="true">
  <div class="modal-content" id="commonModalContent" onclick="event.stopPropagation()">
    <button id="commonModalClose" class="close-btn" type="button">‚úï</button>
    <h2 class="text-xl font-bold mb-2">Common Modifiers</h2>
    <div id="commonModifiersList" class="space-y-2 text-left"></div>
  </div>
</div>

<script>
/*
  Full app script.
  - Expects: powers.json, edges.json, hindrances.json, traits.json in same origin.
  - Provides: UI, favorites (localStorage), modals, filters, search, PWA registration (below).
*/

let data = {};
let favorites = { powers: new Set(), edges: new Set(), hindrances: new Set() };
let currentMain = 'powers';
let currentSub = 'all';
let currentEdgeCategoryOptions = new Set();

/* Elements */
const itemsList = document.getElementById('itemsList');

const modal = document.getElementById('modal');
const modalName = document.getElementById('modalName');
const modalRank = document.getElementById('modalRank');
const modalStats = document.getElementById('modalStats');
const modalText = document.getElementById('modalText');
const modalModifiers = document.getElementById('modalModifiers');
const modalModifiersContainer = document.getElementById('modalModifiersContainer');
const modalSource = document.getElementById('modalSource');
const modalFavBtn = document.getElementById('modalFavBtn');
const modalCopyBtn = document.getElementById('modalCopyBtn');
const modalClose = document.getElementById('modalClose');

const tab_powers = document.getElementById('tab_powers');
const tab_edges = document.getElementById('tab_edges');
const tab_hindrances = document.getElementById('tab_hindrances');
const tab_traits = document.getElementById('tab_traits');

const controls_powers = document.getElementById('controls_powers');
const controls_edges = document.getElementById('controls_edges');
const controls_hindrances = document.getElementById('controls_hindrances');
const controls_traits = document.getElementById('controls_traits');

const powers_view_my = document.getElementById('powers_view_my');
const edges_view_my = document.getElementById('edges_view_my');
const hindrances_view_my = document.getElementById('hindrances_view_my');

const rankFilter_powers = document.getElementById('rankFilter_powers');
const searchBox_powers = document.getElementById('searchBox_powers');
const clearBtn_powers = document.getElementById('clearBtn_powers');
const btnCommonMods = document.getElementById('btnCommonMods');

const rankFilter_edges = document.getElementById('rankFilter_edges');
const categoryFilter_edges = document.getElementById('categoryFilter_edges');
const searchBox_edges = document.getElementById('searchBox_edges');
const clearBtn_edges = document.getElementById('clearBtn_edges');

const typeFilter_hindrances = document.getElementById('typeFilter_hindrances');
const searchBox_hindrances = document.getElementById('searchBox_hindrances');
const clearBtn_hindrances = document.getElementById('clearBtn_hindrances');

const commonModal = document.getElementById('commonModal');
const commonModifiersList = document.getElementById('commonModifiersList');
const commonModalClose = document.getElementById('commonModalClose');

/* Safe hookups (if elements exist) */
typeFilter_hindrances && (typeFilter_hindrances.onchange = () => renderCurrentView());
rankFilter_powers && (rankFilter_powers.onchange = () => renderCurrentView());
searchBox_powers && (searchBox_powers.oninput = () => renderCurrentView());
rankFilter_edges && (rankFilter_edges.onchange = () => renderCurrentView());
categoryFilter_edges && (categoryFilter_edges.onchange = () => renderCurrentView());
searchBox_edges && (searchBox_edges.oninput = () => renderCurrentView());
searchBox_hindrances && (searchBox_hindrances.oninput = () => renderCurrentView());

/* Clear buttons: clear the search input and re-render */
clearBtn_powers && (clearBtn_powers.onclick = () => {
  if (searchBox_powers) searchBox_powers.value = '';
  renderCurrentView();
});
clearBtn_edges && (clearBtn_edges.onclick = () => {
  if (searchBox_edges) searchBox_edges.value = '';
  renderCurrentView();
});
clearBtn_hindrances && (clearBtn_hindrances.onclick = () => {
  if (searchBox_hindrances) searchBox_hindrances.value = '';
  renderCurrentView();
});

/* common modifiers modal */
btnCommonMods && (btnCommonMods.onclick = () => commonModal.classList.add('open'));
commonModalClose && (commonModalClose.onclick = () => commonModal.classList.remove('open'));
commonModal && (commonModal.onclick = (e) => { if (e.target === commonModal) commonModal.classList.remove('open'); });

/* Data loading */
async function loadData() {
  try {
    const [powersRes, edgesRes, hindrancesRes, traitsRes] = await Promise.all([
      fetch('powers.json'),
      fetch('edges.json'),
      fetch('hindrances.json'),
      fetch('traits.json')
    ]);

    const powers = await powersRes.json();
    const edges = await edgesRes.json();
    const hindrances = await hindrancesRes.json();
    const traits = await traitsRes.json();

    data = {
      powers: powers.powers || [],
      edges: edges.edges || [],
      hindrances: hindrances.hindrances || [],
      traits: traits.traits || [],
      common_modifiers: powers.common_modifiers || []
    };

    (data.edges || []).forEach(e => { if (e.category) currentEdgeCategoryOptions.add(e.category); });
    populateEdgeCategories();
    loadFavorites();
    renderCommonModifiers();
    showMain('powers');
  } catch (err) {
    console.error('Failed to load data:', err);
    itemsList.innerHTML = '<div class="p-4 text-red-700">Failed to load data ‚Äî check console for details.</div>';
  }
}

function populateEdgeCategories() {
  if (!categoryFilter_edges) return;
  categoryFilter_edges.innerHTML = '<option value="">All Categories</option>';
  Array.from(currentEdgeCategoryOptions).sort().forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    categoryFilter_edges.appendChild(opt);
  });
}

/* Favorites persistence */
function loadFavorites() {
  const stored = localStorage.getItem('favorites');
  if (stored) {
    try {
      const parsed = JSON.parse(stored);
      favorites.powers = new Set(parsed.powers || []);
      favorites.edges = new Set(parsed.edges || []);
      favorites.hindrances = new Set(parsed.hindrances || []);
    } catch (e) {
      console.warn('Could not parse favorites from localStorage', e);
    }
  }
}
function saveFavorites() {
  localStorage.setItem('favorites', JSON.stringify({
    powers: [...favorites.powers],
    edges: [...favorites.edges],
    hindrances: [...favorites.hindrances]
  }));
}
function toggleFavorite(kind, id) {
  id = String(id);
  const set = favorites[kind];
  set.has(id) ? set.delete(id) : set.add(id);
  saveFavorites();
  renderCurrentView();
}

/* Tab switching & active highlight */
function clearActiveMain() {
  [tab_powers, tab_edges, tab_hindrances, tab_traits].forEach(t => t && t.classList.remove('tab-active'));
  [powers_view_my, edges_view_my, hindrances_view_my].forEach(b => b && b.classList.remove('tab-active'));
  [controls_powers, controls_edges, controls_hindrances, controls_traits].forEach(c => c && c.classList.add('hidden'));
  currentSub = 'all';
}
function showMain(main) {
  currentMain = main;
  clearActiveMain();
  if (main === 'powers') { tab_powers.classList.add('tab-active'); controls_powers.classList.remove('hidden'); }
  if (main === 'edges') { tab_edges.classList.add('tab-active'); controls_edges.classList.remove('hidden'); }
  if (main === 'hindrances') { tab_hindrances.classList.add('tab-active'); controls_hindrances.classList.remove('hidden'); }
  if (main === 'traits') { tab_traits.classList.add('tab-active'); controls_traits.classList.remove('hidden'); }
  renderCurrentView();
}
tab_powers && (tab_powers.onclick = () => showMain('powers'));
tab_edges && (tab_edges.onclick = () => showMain('edges'));
tab_hindrances && (tab_hindrances.onclick = () => showMain('hindrances'));
tab_traits && (tab_traits.onclick = () => showMain('traits'));

/* "My" buttons: switch to tab and show favorites, highlight the child button.
   After calling showMain we remove the parent's active class so only the child shows highlighted. */
powers_view_my && (powers_view_my.onclick = () => {
  showMain('powers');
  currentSub='my';
  powers_view_my.classList.add('tab-active');
  tab_powers.classList.remove('tab-active');
  renderCurrentView();
});
edges_view_my && (edges_view_my.onclick = () => {
  showMain('edges');
  currentSub='my';
  edges_view_my.classList.add('tab-active');
  tab_edges.classList.remove('tab-active');
  renderCurrentView();
});
hindrances_view_my && (hindrances_view_my.onclick = () => {
  showMain('hindrances');
  currentSub='my';
  hindrances_view_my.classList.add('tab-active');
  tab_hindrances.classList.remove('tab-active');
  renderCurrentView();
});

/* Render dispatcher */
function renderCurrentView() {
  itemsList.innerHTML = '';
  if (currentMain === 'powers') renderPowers();
  if (currentMain === 'edges') renderEdges();
  if (currentMain === 'hindrances') renderHindrances();
  if (currentMain === 'traits') renderTraits();
}

/* Renders */
function renderPowers() {
  let list = (data.powers || []).slice();
  const rank = rankFilter_powers ? rankFilter_powers.value : '';
  const q = searchBox_powers ? searchBox_powers.value.toLowerCase().trim() : '';
  if (rank) list = list.filter(p => p.rank === rank);
  if (q) list = list.filter(p => (p.name + ' ' + (p.summary || '') + ' ' + (p.full_text || '')).toLowerCase().includes(q));
  if (currentSub === 'my') list = list.filter(p => favorites.powers.has(String(p.id)));
  if (!list.length) { itemsList.innerHTML = '<div class="p-4 text-gray-600">No powers found.</div>'; return; }

  list.forEach(p => {
    const card = document.createElement('div');
    card.className = 'border rounded p-3 bg-white cursor-pointer hover:shadow';
    card.innerHTML = `<div class="flex justify-between items-center"><span class="font-semibold">${escapeHtml(p.name)}</span>
      <div class="flex items-center gap-2"><span class="text-sm text-gray-600">${escapeHtml(p.rank || '')}</span>
      <button class="text-xl favbtn" type="button">${favorites.powers.has(String(p.id)) ? '‚≠ê' : '‚òÜ'}</button></div></div>
      <div class="text-xs text-gray-700 mt-1 flex gap-2"><span>üîã ${escapeHtml(p.power_points || '')}</span><span>üìè ${escapeHtml(p.range || '')}</span><span>üïë ${escapeHtml(p.duration || '')}</span></div>
      <p class="text-sm mt-2 summary-text">${escapeHtml(p.summary || '')}</p>`;
    const favBtn = card.querySelector('.favbtn');
    favBtn.onclick = e => { e.stopPropagation(); toggleFavorite('powers', p.id); };
    card.onclick = () => openModal('powers', p);
    itemsList.appendChild(card);
  });
}

function renderEdges() {
  let list = (data.edges || []).slice();
  const rank = rankFilter_edges ? rankFilter_edges.value : '';
  const cat = categoryFilter_edges ? categoryFilter_edges.value : '';
  const q = searchBox_edges ? searchBox_edges.value.toLowerCase().trim() : '';
  if (rank) list = list.filter(e => e.rank === rank);
  if (cat) list = list.filter(e => e.category === cat);
  if (q) list = list.filter(e => (e.name + ' ' + (e.summary || '') + ' ' + (e.description || '')).toLowerCase().includes(q));
  if (currentSub === 'my') list = list.filter(e => favorites.edges.has(String(e.id)));
  if (!list.length) { itemsList.innerHTML = '<div class="p-4 text-gray-600">No edges found.</div>'; return; }

  list.forEach(e => {
    const card = document.createElement('div');
    card.className = 'border rounded p-3 bg-white cursor-pointer hover:shadow';
    card.innerHTML = `<div class="flex justify-between items-start">
      <div class="flex flex-col">
        <span class="font-semibold">${escapeHtml(e.name)}</span>
        ${e.rank ? `<span class="text-xs text-gray-600 mt-0.5">Rank: ${escapeHtml(e.rank)}</span>` : ''}
        ${e.requirements ? `<span class="text-xs italic text-red-700 mt-1 break-words">${escapeHtml(e.requirements)}</span>` : ''}
        <p class="text-sm mt-2">${escapeHtml(e.summary || '')}</p>
      </div>
      <button class="text-xl favbtn mt-1" type="button">${favorites.edges.has(String(e.id)) ? '‚≠ê' : '‚òÜ'}</button>
    </div>`;
    const favBtn = card.querySelector('.favbtn');
    favBtn.onclick = ev => { ev.stopPropagation(); toggleFavorite('edges', e.id); };
    card.onclick = () => openModal('edges', e);
    itemsList.appendChild(card);
  });
}

function renderHindrances() {
  let list = (data.hindrances || []).slice();
  const type = typeFilter_hindrances ? typeFilter_hindrances.value.toLowerCase().trim() : '';
  const q = searchBox_hindrances ? searchBox_hindrances.value.toLowerCase().trim() : '';
  if (type) {
    list = list.filter(h => {
      const hType = (h.type || '').toLowerCase();
      if (type === 'minor') return hType === 'minor' || hType === 'minor/major';
      if (type === 'major') return hType === 'major' || hType === 'minor/major';
      return false;
    });
  }
  if (q) list = list.filter(h => (h.name + ' ' + (h.summary || '') + ' ' + (h.description || '')).toLowerCase().includes(q));
  if (currentSub === 'my') list = list.filter(h => favorites.hindrances.has(String(h.id)));
  if (!list.length) { itemsList.innerHTML = '<div class="p-4 text-gray-600">No hindrances found.</div>'; return; }

  list.forEach(h => {
    const card = document.createElement('div');
    card.className = 'border rounded p-3 bg-white cursor-pointer hover:shadow';
    card.innerHTML = `<div class="flex justify-between items-center"><span class="font-semibold">${escapeHtml(h.name)}</span>
      <div class="flex items-center gap-2"><span class="text-sm text-gray-600">${escapeHtml(h.type || '')}</span>
      <button class="text-xl favbtn" type="button">${favorites.hindrances.has(String(h.id)) ? '‚≠ê' : '‚òÜ'}</button></div></div>
      <p class="text-sm mt-2 summary-text">${escapeHtml(h.summary || '')}</p>`;
    const favBtn = card.querySelector('.favbtn');
    favBtn.onclick = ev => { ev.stopPropagation(); toggleFavorite('hindrances', h.id); };
    card.onclick = () => openModal('hindrances', h);
    itemsList.appendChild(card);
  });
}

function renderTraits() {
  let list = (data.traits || []).slice();
  if (!list.length) { itemsList.innerHTML = '<div class="p-4 text-gray-600">No traits found.</div>'; return; }

  list.forEach((t, idx) => {
    const card = document.createElement('div');
    // First five trait cards get only the background highlight (text color remains default)
    const highlightClass = idx < 5 ? 'trait-card-highlight' : 'bg-white';
    card.className = `border rounded p-3 ${highlightClass}`;
    card.innerHTML = `<div class="mb-1 font-semibold">${escapeHtml(t.name)}</div>
      <span class="trait-parent">${escapeHtml(t.parent || '')}</span>
      <p class="text-sm mt-1 summary-text">${escapeHtml(t.description || '')}</p>`;
    itemsList.appendChild(card);
  });
}

/* Modal functions */
function openModal(kind, item) {
  modal.classList.add('open');
  modalName.textContent = item.name || '';
  modalRank.textContent = item.rank ? 'Rank: ' + item.rank : item.type ? 'Type: ' + item.type : '';
  modalStats.innerHTML = '';
  if (kind === 'powers') modalStats.innerHTML = `<div>üîã Power Points: ${escapeHtml(item.power_points || '')}</div><div>üìè Range: ${escapeHtml(item.range || '')}</div><div>üïë Duration: ${escapeHtml(item.duration || '')}</div>`;
  else if (kind === 'edges') modalStats.innerHTML = `<div>Category: ${escapeHtml(item.category || '')}</div><div>Requirements: ${escapeHtml(item.requirements || '')}</div>`;
  else if (kind === 'hindrances') modalStats.innerHTML = `<div>Type: ${escapeHtml(item.type || '')}</div>`;
  modalText.innerHTML = escapeHtml(item.full_text || item.description || item.summary || '');
  modalSource.textContent = item.source ? 'Source: ' + item.source : '';
  modalFavBtn.textContent = favorites[kind].has(String(item.id)) ? `‚≠ê Remove from My ${kind}` : `‚òÜ Add to My ${kind}`;
  modalFavBtn.onclick = () => { toggleFavorite(kind, item.id); closeModal(); };
  modalCopyBtn.onclick = () => {
    const text = `${item.name || ''} ${item.rank ? '(' + item.rank + ')' : ''}\n${item.summary || item.description || ''}\n\n${item.full_text || ''}`;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text);
    } else {
      // fallback: create temporary textarea
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); } catch(e) {}
      document.body.removeChild(ta);
    }
    modalCopyBtn.textContent = 'Copied!';
    setTimeout(() => modalCopyBtn.textContent = 'Copy Summary', 1200);
  };
}

function closeModal() { modal.classList.remove('open'); }
modalClose && (modalClose.onclick = closeModal);
modal && (modal.onclick = e => { if (e.target === modal) closeModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

/* common modifiers */
function renderCommonModifiers() {
  if (!commonModifiersList) return;
  commonModifiersList.innerHTML = '';
  (data.common_modifiers || []).forEach(m => {
    commonModifiersList.insertAdjacentHTML('beforeend', `<div class="border rounded p-3 bg-gray-50 text-left">
      <p class="font-semibold text-red-700">‚ñ™ ${escapeHtml(m.name)} <span class="text-gray-800">(${escapeHtml(m.cost || '')})</span></p>
      <p class="text-sm text-gray-800 ml-4">${escapeHtml(m.description || '')}</p>
    </div>`);
  });
}

/* Utilities */
function escapeHtml(s) {
  if (s == null) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

/* init */
document.addEventListener('DOMContentLoaded', loadData);

/* --- PWA: register service worker (sw.js) if available --- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(reg => {
      console.log('Service worker registered.', reg);
    }).catch(err => {
      console.warn('Service worker registration failed:', err);
    });
  });
}
</script>
</body>
</html>
